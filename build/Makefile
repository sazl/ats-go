.PHONY: all debug cats-parsemit clean check

CPF=cp -f
RMF=rm -f

CFLAGS = -O2
CFLAGS_DEBUG = -O0 -g

LDFLAGS = -lgc -DATS_MEMALLOC_GCBDW
LDFLAGS_DEBUG = -lgc -DATS_MEMALLOC_GCBDW

PATSCC = $(PATSHOME)/bin/patscc
PATSOPT = $(PATSHOME)/bin/patsopt

SOURCE_FOLDER = ./../src
DATS_FOLDER = $(SOURCE_FOLDER)/DATS
SATS_FOLDER = $(SOURCE_FOLDER)/SATS

CATSPARSEMIT = ./../vendor/CATS-parsemit
CATSPARSEMIT_CATS_FOLDER = $(CATSPARSEMIT)/CATS
CATSPARSEMIT_SATS_FOLDER = $(CATSPARSEMIT)/SATS

CATSPARSEMIT_DATS = $(CATSPARSEMIT)/catsparse_all.dats
CATSPARSEMIT_SATS = $(CATSPARSEMIT_SATS_FOLDER)/catsparse.sats
CATSPARSEMIT_CATS = $(CATSPARSEMIT_CATS_FOLDER)/catsparse_all_dats.c
CATSPARSEMIT_CATS_OBJECTS = $(CATSPARSEMIT_CATS:$(CATSPARSEMIT_CATS_FOLDER)/%_dats.c=%_dats.o)
CATSPARSEMIT_SATS_OBJECTS = $(CATSPARSEMIT_SATS:$(CATSPARSEMIT_SATS_FOLDER)/%.sats=%_sats.o)

SOURCES_DATS = $(wildcard $(DATS_FOLDER)/*.dats)
SOURCES_SATS = $(wildcard $(SATS_FOLDER)/*.sats)

TARGET_DATS = $(SOURCES_DATS:$(DATS_FOLDER)/%.dats=%_dats.c)
TARGET_SATS = $(SOURCES_SATS:$(SATS_FOLDER)/%.sats=%_sats.c)

OBJECT_DATS = $(SOURCES_DATS:$(DATS_FOLDER)/%.dats=%_dats.o)
OBJECT_SATS = $(SOURCES_SATS:$(SATS_FOLDER)/%.sats=%_sats.o)
OBJECTS = \
	$(OBJECT_DATS) \
	$(OBJECT_SATS) \
	$(CATSPARSEMIT_CATS_OBJECTS) \
	$(CATSPARSEMIT_SATS_OBJECTS)


check:
	@echo "PATSCC: $(PATSCC)"
	@echo "PATSHOME: $(PATSHOME)"

	@echo "\n---- SOURCE ----\n"
	@echo "DATS_FOLDER: $(DATS_FOLDER)"
	@echo "SATS_FOLDER: $(SATS_FOLDER)"
	@echo "CATSPARSEMIT: $(CATSPARSEMIT)"
	@echo "SOURCES_DATS: $(SOURCES_DATS)"
	@echo "SOURCES_SATS: $(SOURCES_SATS)"

	@echo "\n---- OBJECTS ----\n"
	@echo "OBJECT_DATS: $(OBJECT_DATS)"
	@echo "OBJECT_SATS: $(OBJECT_SATS)"
	@echo "OBJECTS: $(OBJECTS)"

	@echo "\n---- TARGET ----\n"
	@echo "TARGET_DATS: $(TARGET_DATS)"
	@echo "TARGET_SATS: $(TARGET_SATS)"

	@echo "\n---- CATSPARSEMIT ----\n"
	@echo "CATSPARSEMIT_CATS: $(CATSPARSEMIT_CATS)"
	@echo "CATSPARSEMIT_SATS: $(CATSPARSEMIT_SATS)"
	@echo "CATSPARSEMIT_CATS_OBJECTS: $(CATSPARSEMIT_CATS_OBJECTS)"
	@echo "CATSPARSEMIT_SATS_OBJECTS: $(CATSPARSEMIT_SATS_OBJECTS)"

all: ats-go

debug: CFLAGS = $(CFLAGS_DEBUG)
debug: LDFLAGS = $(LDFLAGS_DEBUG)
debug: ats-go

$(CATSPARSEMIT_CATS): $(CATSPARSEMIT_DATS)
	$(MAKE) -C $(CATSPARSEMIT) all
$(CATSPARSEMIT_CATS_OBJECTS): $(CATSPARSEMIT_CATS)
	$(PATSCC) $(CFLAGS) -c $^ -o $@
$(CATSPARSEMIT_SATS_OBJECTS): $(CATSPARSEMIT_SATS)
	$(PATSCC) $(CFLAGS) -c $^ -o $@

%_dats.o: $(DATS_FOLDER)/%.dats
	$(PATSCC) $(CFLAGS) -c $^ -o $@ $(LDFLAGS)
%_sats.o: $(SATS_FOLDER)/%.sats
	$(PATSCC) $(CFLAGS) -c $^ -o $@ $(LDFLAGS)

ats-go: $(OBJECTS)
	$(PATSCC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

clean:
	$(RMF) *_?ats.o
	$(RMF) *_?ats.c
	$(RMF) ats-go
